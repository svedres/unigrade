<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniGrade - ELTE GTK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1a202c;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-particles {
            position: fixed;
            inset: 0;
            z-index: 0;
            opacity: 0.3;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate3d(0, 0, 0) rotate(0); }
            50% { transform: translate3d(0, -20px, 0) rotate(180deg); }
        }

        .main-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding-top: 80px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }

        .btn-primary:hover:not(:disabled)::before { left: 100%; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .kpi-card {
            background: white;
            padding: 24px;
            border-radius: 20px;
            border: 2px solid transparent;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .kpi-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
        }

        .kpi-card::before {
            content: "";
            position: absolute;
            inset: 0 auto auto 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .kpi-card:hover::before { transform: scaleX(1); }

        .kpi-number {
            font-size: 40px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-container {
            background: #e2e8f0;
            border-radius: 999px;
            height: 12px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.8s;
            position: relative;
        }

        .progress-bar::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .tab-container {
            background: white;
            border-radius: 16px;
            display: inline-flex;
            gap: 4px;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .tab-item {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            color: #64748b;
            border: none;
            background: transparent;
            transition: all 0.2s;
        }

        .tab-item:hover { color: #667eea; background: #f1f5f9; }
        .tab-item.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }

        .modern-input {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 12px 16px;
            transition: border 0.2s, box-shadow 0.2s;
            outline: none;
        }

        .modern-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .modern-input::placeholder { color: #94a3b8; }

        .modern-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
        }

        .modern-table thead th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            color: #64748b;
            font-weight: 700;
        }

        .modern-table tbody tr {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: 0.2s;
        }

        .modern-table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .modern-table td { padding: 16px; }

        .modern-table tbody tr td:first-child { border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
        .modern-table tbody tr td:last-child { border-top-right-radius: 12px; border-bottom-right-radius: 12px; }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-error { background: #fee2e2; color: #991b1b; }
        .badge-pending { background: #e0e7ff; color: #3730a3; }

        .grade-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 18px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .grade-5 { background: linear-gradient(135deg,#10b981,#059669); }
        .grade-4 { background: linear-gradient(135deg,#3b82f6,#2563eb); }
        .grade-3 { background: linear-gradient(135deg,#f59e0b,#d97706); }
        .grade-2 { background: linear-gradient(135deg,#ef4444,#dc2626); }
        .grade-1 { background: linear-gradient(135deg,#6b7280,#4b5563); }

        .empty-state-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg,#667eea,#764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            font-size: 48px;
            justify-content: center;
            align-items: center;
            margin: 0 auto 24px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .error-message {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 16px;
            color: #991b1b;
            border-radius: 12px;
            margin-bottom: 16px;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .animate-scale-in {
            animation: scaleIn 0.4s ease-out forwards;
        }

        @media (max-width: 768px) {
            .main-container { padding-top: 60px; }
            .kpi-card { padding: 16px; }
            .tab-item { padding: 8px 16px; font-size: 12px; }
            .tab-item i { display: none; }
        }
    </style>
</head>
<body>
    <div id="particles" class="bg-particles"></div>

    <nav class="fixed top-0 w-full z-50 nav-glass">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-4 cursor-pointer" onclick="app.reload()">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-700 flex items-center justify-center shadow-lg">
                    <i class="fas fa-graduation-cap text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">UniGrade</h1>
                    <p class="text-xs text-gray-500">ELTE GTK</p>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="undo-btn" onclick="app.undo()" class="btn btn-secondary px-4" disabled title="Visszavon√°s (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button id="redo-btn" onclick="app.redo()" class="btn btn-secondary px-4" disabled title="√öjra (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
                <button onclick="app.openImportModal()" class="btn btn-primary flex items-center gap-2 shadow-lg">
                    <i class="fas fa-file-import"></i>
                    <span class="hidden sm:inline">Import</span>
                </button>
                <button onclick="app.resetData()" class="btn btn-secondary px-4" title="√ñsszes adat t√∂rl√©se">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="max-w-7xl mx-auto px-6 pb-20">
            <div id="error-container"></div>

            <div class="text-center mb-12 animate-fade-in-up">
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-4">Tanulm√°nyi Eredm√©nyek</h2>
                <p class="text-purple-100 text-lg">K√∂vesd nyomon a halad√°sod √©s √©rj el nagyszer≈± eredm√©nyeket! üéØ</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 md:gap-6 mb-12">
                <div class="kpi-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                        <i class="fas fa-chart-line text-purple-500"></i> Tanulm√°nyi √Åtlag
                    </p>
                    <h2 id="kpi-weighted-avg" class="kpi-number mb-3">0.00</h2>
                    <div class="progress-container"><div id="bar-weighted" class="progress-bar" style="width:0"></div></div>
                </div>

                <div class="kpi-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                        <i class="fas fa-university text-purple-500"></i> GTK √Åtlag
                    </p>
                    <h2 id="kpi-gtk-avg" class="kpi-number mb-3">0.00</h2>
                    <div class="progress-container"><div id="bar-gtk" class="progress-bar" style="width:0"></div></div>
                </div>

                <div class="kpi-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                        <i class="fas fa-star text-purple-500"></i> Kreditindex
                    </p>
                    <h2 id="kpi-ci" class="kpi-number">0.00</h2>
                </div>

                <div class="kpi-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                        <i class="fas fa-award text-purple-500"></i> Korrig√°lt KI
                    </p>
                    <h2 id="kpi-kki" class="kpi-number">0.00</h2>
                </div>

                <div class="kpi-card">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1 flex items-center gap-2">
                        <i class="fas fa-check-circle text-purple-500"></i> Teljes√≠tve
                    </p>
                    <h2 class="flex items-baseline gap-2">
                        <span id="kpi-completed" class="kpi-number">0</span>
                        <span class="text-gray-500 font-medium text-sm">/ <span id="kpi-taken">0</span> kr</span>
                    </h2>
                </div>
            </div>

            <div class="flex justify-center mb-8">
                <div class="tab-container">
                    <button id="tab-grades" class="tab-item active" onclick="app.switchTab('grades')">
                        <i class="fas fa-clipboard-list mr-2"></i>Z√°rthelyik
                    </button>
                    <button id="tab-extras" class="tab-item" onclick="app.switchTab('extras')">
                        <i class="fas fa-plus-circle mr-2"></i>Pluszpontok
                    </button>
                    <button id="tab-summary" class="tab-item" onclick="app.switchTab('summary')">
                        <i class="fas fa-chart-pie mr-2"></i>√ñsszegz≈ë
                    </button>
                    <button id="tab-gpa" class="tab-item" onclick="app.switchTab('gpa')">
                        <i class="fas fa-graduation-cap mr-2"></i>T√°rgyak
                    </button>
                </div>
            </div>

            <div class="glass-card p-8 min-h-[500px]">
                <div id="empty-state" class="hidden text-center py-12">
                    <div class="empty-state-icon"><i class="fas fa-rocket"></i></div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-3">Kezdj√ºnk neki! üöÄ</h2>
                    <p class="text-gray-600 text-lg mb-8">Adj hozz√° tant√°rgyakat vagy import√°lj Excel f√°jlt!</p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <button onclick="app.switchTab('gpa'); app.addSubject()" class="btn btn-primary">
                            <i class="fas fa-plus-circle mr-2"></i>√öj Tant√°rgy
                        </button>
                        <button onclick="app.openImportModal()" class="btn btn-secondary">
                            <i class="fas fa-file-import mr-2"></i>Excel Import
                        </button>
                    </div>
                </div>

                <div id="view-grades"></div>
                <div id="view-extras" class="hidden"></div>
                <div id="view-summary" class="hidden"></div>
                <div id="view-gpa" class="hidden"></div>
            </div>
        </div>
    </div>

    <div id="import-modal" class="modal-backdrop hidden"></div>

    <footer class="w-full py-6 px-6 text-sm text-white/90 bg-black/20 border-t border-white/10">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-2">
            <div class="text-center sm:text-left">
                ¬© ELTE GTK Hallgat√≥i √ñnkorm√°nyzat<br>
                <a href="mailto:info@gtkhok.elte.hu" class="hover:text-white transition-colors">info@gtkhok.elte.hu</a>
            </div>
            <div class="text-center sm:text-right">
                Developer: <strong>Vedres Szabolcs</strong>
            </div>
        </div>
    </footer>

    <script>
const app = (() => {
    let state = {
        subjects: [],
        grades: [],
        extras: [],
        manualExamGrades: {},
        currentTab: "grades",
        nextId: 1
    };

    const STORAGE_KEY = "elteGtkData";
    const MAX_STORAGE_SIZE = 4.5 * 1024 * 1024;
    const GRADE_THRESHOLDS = { 5: 85, 4: 70, 3: 60, 2: 50 };
    let pendingImport = null;

    // Undo/Redo system
    let history = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;

    const generateId = () => `id_${Date.now()}_${state.nextId++}`;

    const sanitizeInput = (value, type = "string") => {
        if (type === "number") {
            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }
        return String(value).trim().slice(0, 200);
    };

    const showError = (msg) => {
        const box = document.getElementById("error-container");
        if (!box) return;
        const el = document.createElement("div");
        el.className = "error-message";
        el.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>${msg}`;
        box.appendChild(el);
        setTimeout(() => el.remove(), 5000);
    };

    const createParticles = () => {
        const container = document.getElementById("particles");
        if (!container) return;
        for (let i = 0; i < 20; i++) {
            const p = document.createElement("div");
            p.className = "particle";
            const size = Math.random() * 6 + 2;
            p.style.width = size + "px";
            p.style.height = size + "px";
            p.style.left = Math.random() * 100 + "%";
            p.style.top = Math.random() * 100 + "%";
            p.style.animationDuration = 4 + Math.random() * 4 + "s";
            p.style.animationDelay = Math.random() * 5 + "s";
            container.appendChild(p);
        }
    };

    const loadData = () => {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                saveToHistory();
                return;
            }
            const data = JSON.parse(raw);
            state.subjects = Array.isArray(data.subjects) ? data.subjects : [];
            state.grades = Array.isArray(data.grades) ? data.grades : [];
            state.extras = Array.isArray(data.extras) ? data.extras : [];
            state.manualExamGrades = data.manualExamGrades || {};
            const maxId = Math.max(
                ...["subjects", "grades", "extras"]
                    .flatMap(key => (data[key] || []).map(i => parseInt(i.id?.split("_")[2]) || 0)),
                0
            );
            state.nextId = maxId + 1;
            
            // Initialize history with current state
            saveToHistory();
        } catch (e) {
            console.error("Load error:", e);
            showError("Hiba az adatok bet√∂lt√©sekor.");
        }
    };

    const saveData = () => {
        try {
            const json = JSON.stringify({
                subjects: state.subjects,
                grades: state.grades,
                extras: state.extras,
                manualExamGrades: state.manualExamGrades
            });
            if (json.length > MAX_STORAGE_SIZE) {
                showError("T√∫l sok adat!");
                return false;
            }
            localStorage.setItem(STORAGE_KEY, json);
            saveToHistory();
            render();
            return true;
        } catch (e) {
            console.error("Save error:", e);
            showError("Nem siker√ºlt elmenteni.");
            return false;
        }
    };

    const saveToHistory = () => {
        const snapshot = JSON.stringify({
            subjects: JSON.parse(JSON.stringify(state.subjects)),
            grades: JSON.parse(JSON.stringify(state.grades)),
            extras: JSON.parse(JSON.stringify(state.extras)),
            manualExamGrades: JSON.parse(JSON.stringify(state.manualExamGrades)),
            nextId: state.nextId
        });

        // Remove any future history if we're not at the end
        if (historyIndex < history.length - 1) {
            history = history.slice(0, historyIndex + 1);
        }

        // Add new state
        history.push(snapshot);

        // Limit history size
        if (history.length > MAX_HISTORY) {
            history.shift();
        } else {
            historyIndex++;
        }

        updateUndoRedoButtons();
    };

    const undo = () => {
        if (historyIndex <= 0) return;
        
        historyIndex--;
        restoreFromHistory(historyIndex);
    };

    const redo = () => {
        if (historyIndex >= history.length - 1) return;
        
        historyIndex++;
        restoreFromHistory(historyIndex);
    };

    const restoreFromHistory = (index) => {
        try {
            const snapshot = JSON.parse(history[index]);
            state.subjects = snapshot.subjects;
            state.grades = snapshot.grades;
            state.extras = snapshot.extras;
            state.manualExamGrades = snapshot.manualExamGrades;
            state.nextId = snapshot.nextId;

            // Save to localStorage without adding to history
            const json = JSON.stringify({
                subjects: state.subjects,
                grades: state.grades,
                extras: state.extras,
                manualExamGrades: state.manualExamGrades
            });
            localStorage.setItem(STORAGE_KEY, json);

            updateUndoRedoButtons();
            render();
        } catch (e) {
            console.error("Restore error:", e);
            showError("Hiba a vissza√°ll√≠t√°skor.");
        }
    };

    const updateUndoRedoButtons = () => {
        const undoBtn = document.getElementById("undo-btn");
        const redoBtn = document.getElementById("redo-btn");
        
        if (undoBtn) {
            undoBtn.disabled = historyIndex <= 0;
        }
        
        if (redoBtn) {
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
    };

    const getSubject = (id) => state.subjects.find(s => s.id === id);

    const calculateSubjectGradePoints = (sid) =>
        state.grades
            .filter(g => g.subjectId === sid && g.score !== null)
            .reduce((s, g) => s + sanitizeInput(g.score, "number"), 0);

    const calculateSubjectExtraPoints = (sid) =>
        Math.min(
            state.extras
                .filter(e => e.subjectId === sid)
                .reduce((s, e) => s + (e.score || 0), 0),
            10
        );

    const calculateRecommendedGrade = (total) => {
        if (total >= GRADE_THRESHOLDS[5]) return 5;
        if (total >= GRADE_THRESHOLDS[4]) return 4;
        if (total >= GRADE_THRESHOLDS[3]) return 3;
        if (total >= GRADE_THRESHOLDS[2]) return 2;
        return 1;
    };

    const getFinalGrade = (sid) =>
        state.manualExamGrades[sid] ??
        calculateRecommendedGrade(calculateSubjectGradePoints(sid) + calculateSubjectExtraPoints(sid));

    const render = () => {
        document.getElementById("empty-state")?.classList.toggle("hidden", state.subjects.length > 0);
        switch (state.currentTab) {
            case "grades": return renderGrades();
            case "extras": return renderExtras();
            case "summary": return renderSummary();
            case "gpa": return renderGPA();
        }
    };

    const renderGPA = () => {
        const root = document.getElementById("view-gpa");
        root.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">Tant√°rgyak</h3>
                    <p class="text-gray-500">T√°rgyak, kreditek, v√©gs≈ë jegyek</p>
                </div>
                <button onclick="app.addSubject()" class="btn btn-primary shadow-lg">
                    <i class="fas fa-plus mr-2"></i> √öj Tant√°rgy
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Tant√°rgy</th>
                            <th class="text-center">Kredit</th>
                            <th class="text-center">K√∂telez≈ë</th>
                            <th class="text-center">V√©gs≈ë Jegy</th>
                            <th class="text-right">S√∫ly</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="gpa-body"></tbody>
                </table>
            </div>
        `;

        const tbody = document.getElementById("gpa-body");
        let totalTaken = 0, totalCompleted = 0, weightedSum = 0;
        let gtkWeightedSum = 0, completedCredits = 0, gtkCompletedCredits = 0;

        state.subjects.forEach(sub => {
            const grade = getFinalGrade(sub.id);
            const credit = sanitizeInput(sub.credit, "number");
            totalTaken += credit;
            if (grade >= 2) {
                totalCompleted += credit;
                completedCredits += credit;
                weightedSum += credit * grade;
                if (sub.compulsory) {
                    gtkCompletedCredits += credit;
                    gtkWeightedSum += credit * grade;
                }
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input class="modern-input font-semibold w-full" onchange="app.updateSubject('${sub.id}', 'name', this.value)" value="${sub.name}"></td>
                <td class="text-center"><input type="number" min="1" max="30" class="modern-input w-20 text-center font-bold" onchange="app.updateSubject('${sub.id}', 'credit', this.value)" value="${sub.credit}"></td>
                <td class="text-center"><input type="checkbox" onchange="app.updateSubject('${sub.id}', 'compulsory', this.checked)" ${sub.compulsory ? "checked" : ""} class="w-5 h-5 accent-purple-600"></td>
                <td class="text-center"><div class="grade-circle grade-${grade}">${grade}</div></td>
                <td class="text-right"><span class="font-bold text-lg">${grade >= 2 ? grade * credit : 0}</span></td>
                <td class="text-right"><button onclick="app.deleteSubject('${sub.id}')" class="text-red-500 hover:text-red-700 px-3"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        });

        const weightedAvg = completedCredits ? (weightedSum / completedCredits).toFixed(2) : "0.00";
        const gtkAvg = gtkCompletedCredits ? (gtkWeightedSum / gtkCompletedCredits).toFixed(2) : "0.00";
        const ci = (weightedSum / 30).toFixed(2);
        const kki = totalTaken ? (parseFloat(ci) * (totalCompleted / totalTaken)).toFixed(2) : "0.00";

        document.getElementById("kpi-weighted-avg").innerText = weightedAvg;
        document.getElementById("kpi-gtk-avg").innerText = gtkAvg;
        document.getElementById("kpi-ci").innerText = ci;
        document.getElementById("kpi-kki").innerText = kki;
        document.getElementById("kpi-completed").innerText = totalCompleted;
        document.getElementById("kpi-taken").innerText = totalTaken;
        document.getElementById("bar-weighted").style.width = `${Math.min(100, (weightedAvg / 5) * 100)}%`;
        document.getElementById("bar-gtk").style.width = `${Math.min(100, (gtkAvg / 5) * 100)}%`;
    };

    const renderGrades = () => {
        const root = document.getElementById("view-grades");
        root.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-1">Z√°rthelyik</h3>
                    <p class="text-gray-500">K√∂vesd nyomon a dolgozatokat</p>
                </div>
                <button onclick="app.addGradeRow()" class="btn btn-primary shadow-lg">
                    <i class="fas fa-plus mr-2"></i> √öj ZH
                </button>
            </div>
            <div class="glass-card p-6 mb-6 bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-semibold text-gray-600">H√°tral√©v≈ë dolgozatok</p>
                        <p id="total-remaining" class="text-4xl font-bold text-purple-600">0</p>
                    </div>
                    <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-tasks text-3xl text-purple-600"></i>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>D√°tum</th>
                            <th class="hidden sm:table-cell">Nap</th>
                            <th>T√°rgy</th>
                            <th class="text-center">#</th>
                            <th class="text-center">St√°tusz</th>
                            <th class="text-right">Pont</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="grades-body"></tbody>
                </table>
            </div>
        `;

        const tbody = document.getElementById("grades-body");
        const sorted = [...state.grades].sort((a, b) => new Date(a.date) - new Date(b.date));
        const countMap = {};

        sorted.forEach(g => {
            if (!countMap[g.subjectId]) countMap[g.subjectId] = 0;
            countMap[g.subjectId]++;

            const sub = getSubject(g.subjectId);
            const subName = sub ? sub.name : "Ismeretlen t√°rgy";
            const day = g.date ? new Date(g.date).toLocaleDateString("hu-HU", { weekday: "short" }) : "-";
            const complete = g.score !== null;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="date" value="${g.date}" class="modern-input" onchange="app.updateGrade('${g.id}', 'date', this.value)"></td>
                <td class="hidden sm:table-cell"><span class="badge badge-pending">${day}</span></td>
                <td>
                    <select class="modern-input font-semibold w-full" onchange="app.updateGrade('${g.id}', 'subjectId', this.value)">
                        ${state.subjects.map(s => `<option value="${s.id}" ${s.id === g.subjectId ? "selected" : ""}>${s.name}</option>`).join("")}
                    </select>
                </td>
                <td class="text-center"><span class="badge badge-pending">#${countMap[g.subjectId]}</span></td>
                <td class="text-center">
                    ${complete ? '<span class="badge badge-success"><i class="fas fa-check mr-1"></i>K√©sz</span>' : '<span class="badge badge-warning"><i class="fas fa-clock mr-1"></i>F√ºgg≈ëben</span>'}
                </td>
                <td class="text-right">
                    <input type="number" class="modern-input w-24 text-right font-bold ${complete ? "text-purple-600 border-purple-300" : ""}" value="${g.score ?? ""}" onchange="app.updateGrade('${g.id}', 'score', this.value)" placeholder="-">
                </td>
                <td class="text-right"><button onclick="app.deleteGrade('${g.id}')" class="text-red-500 hover:text-red-700 px-3"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById("total-remaining").innerText = state.grades.filter(x => x.score === null).length;
    };

    const renderExtras = () => {
        const root = document.getElementById("view-extras");
        root.innerHTML = `
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-1">Pluszpontok</h3>
                <p class="text-gray-500">Extra pontok t√°rgyank√©nt</p>
            </div>
        `;

        if (state.subjects.length === 0) {
            root.innerHTML += `
                <div class="text-center py-12">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-purple-100 flex items-center justify-center">
                        <i class="fas fa-book text-2xl text-purple-500"></i>
                    </div>
                    <p class="text-gray-600 mb-4">Nincs felvett t√°rgy</p>
                    <button onclick="app.switchTab('gpa'); app.addSubject()" class="btn btn-primary">
                        <i class="fas fa-plus mr-2"></i>Tant√°rgy hozz√°ad√°sa
                    </button>
                </div>`;
            return;
        }

        let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

        state.subjects.forEach(sub => {
            const es = state.extras.filter(e => e.subjectId === sub.id);
            const total = Math.min(es.reduce((s, e) => s + (e.score || 0), 0), 10);

            html += `
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">${sub.name}</h4>
                            <p class="text-sm text-gray-500"><span class="font-bold text-purple-600">${total.toFixed(1)}</span> / 10 pont</p>
                        </div>
                        <button class="btn btn-primary w-10 h-10 px-0" onclick="app.addExtra('${sub.id}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="progress-container mb-4">
                        <div class="progress-bar" style="width:${(total / 10) * 100}%"></div>
                    </div>
                    ${es.map(e => `
                        <div class="flex items-center gap-2 mb-2 bg-gray-50 p-3 rounded-xl">
                            <input class="modern-input flex-1 text-sm" value="${e.name}" onchange="app.updateExtra('${e.id}','name',this.value)" placeholder="Le√≠r√°s">
                            <input type="number" class="modern-input w-20 text-center text-purple-600 font-bold text-sm" value="${e.score}" step="0.5" onchange="app.updateExtra('${e.id}','score',this.value)">
                            <button onclick="app.deleteExtra('${e.id}')" class="text-red-500 hover:text-red-700 px-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join("")}
                    ${es.length === 0 ? '<p class="text-center text-gray-500 py-4 text-sm"><i class="fas fa-info-circle mr-2"></i>Nincs pluszpont</p>' : ""}
                </div>`;
        });

        html += `</div>`;
        root.innerHTML += html;
    };

    const renderSummary = () => {
        const root = document.getElementById("view-summary");
        root.innerHTML = `
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-1">√ñsszegz≈ë</h3>
                <p class="text-gray-500">Minden t√°rgy pontjai</p>
            </div>
            <div class="overflow-x-auto">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>T√°rgy</th>
                            <th class="text-right">ZH</th>
                            <th class="text-right">Plusz</th>
                            <th class="text-right">√ñsszes</th>
                            <th class="text-center">Hi√°ny</th>
                            <th class="text-center">Pont</th>
                            <th class="text-center">Megaj√°nlott</th>
                            <th class="text-center">Vizsga</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body"></tbody>
                </table>
            </div>
        `;

        const tbody = document.getElementById("summary-body");

        state.subjects.forEach(sub => {
            const z = calculateSubjectGradePoints(sub.id);
            const e = calculateSubjectExtraPoints(sub.id);
            const total = z + e;
            const recommended = calculateRecommendedGrade(total);
            const finalGrade = getFinalGrade(sub.id);

            let missingType, missingPoints, missingClass;

            if (total >= 85) {
                missingType = "El√©rve!";
                missingPoints = "üéâ";
                missingClass = "badge-success";
            } else if (total >= 70) {
                missingType = "5-h√∂z";
                missingPoints = 85 - total;
                missingClass = "badge-warning";
            } else if (total >= 60) {
                missingType = "4-hez";
                missingPoints = 70 - total;
                missingClass = "badge-warning";
            } else if (total >= 50) {
                missingType = "3-hoz";
                missingPoints = 60 - total;
                missingClass = "badge-error";
            } else {
                missingType = "2-h√∂z";
                missingPoints = 50 - total;
                missingClass = "badge-error";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>
                    <b>${sub.name}</b><br>
                    <span class="text-xs text-gray-500">${sub.credit} kredit</span>
                </td>
                <td class="text-right text-lg font-bold text-gray-700">${z.toFixed(1)}</td>
                <td class="text-right text-lg font-bold text-purple-600">${e.toFixed(1)}</td>
                <td class="text-right text-2xl font-bold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">${total.toFixed(1)}</td>
                <td class="text-center"><span class="badge ${missingClass}">${missingType}</span></td>
                <td class="text-center font-bold text-gray-700">${missingPoints}</td>
                <td class="text-center"><div class="grade-circle grade-${recommended} mx-auto">${recommended}</div></td>
                <td class="text-center">
                    <select class="modern-input w-20 font-bold text-center ${finalGrade > 1 ? "text-green-600" : "text-red-600"}" onchange="app.updateExamGrade('${sub.id}', this.value)">
                        <option value="">-</option>
                        ${[1, 2, 3, 4, 5].map(g => `<option value="${g}" ${g === finalGrade ? "selected" : ""}>${g}</option>`).join("")}
                    </select>
                </td>
            `;
            tbody.appendChild(tr);
        });
    };

    const addSubject = () => {
        state.subjects.push({
            id: generateId(),
            name: "√öj Tant√°rgy",
            credit: 3,
            compulsory: true
        });
        saveData();
    };

    const updateSubject = (id, field, value) => {
        const s = state.subjects.find(x => x.id === id);
        if (!s) return;
        if (field === "credit") {
            s.credit = Math.max(0, Math.min(30, sanitizeInput(value, "number")));
        } else if (field === "compulsory") {
            s.compulsory = Boolean(value);
        } else {
            s[field] = sanitizeInput(value);
        }
        saveData();
    };

    const deleteSubject = (id) => {
        if (!confirm("Biztosan t√∂rl√∂d ezt a t√°rgyat?")) return;
        state.subjects = state.subjects.filter(s => s.id !== id);
        state.grades = state.grades.filter(g => g.subjectId !== id);
        state.extras = state.extras.filter(e => e.subjectId !== id);
        delete state.manualExamGrades[id];
        saveData();
    };

    const addGradeRow = () => {
        if (state.subjects.length === 0) {
            showError("El≈ëbb vegy√©l fel egy t√°rgyat!");
            return;
        }
        state.grades.push({
            id: generateId(),
            subjectId: state.subjects[0].id,
            date: new Date().toISOString().split("T")[0],
            score: null
        });
        saveData();
    };

    const updateGrade = (id, field, value) => {
        const g = state.grades.find(x => x.id === id);
        if (!g) return;
        if (field === "score") {
            g.score = value === "" ? null : sanitizeInput(value, "number");
        } else if (field === "subjectId") {
            g.subjectId = value;
        } else {
            g[field] = sanitizeInput(value);
        }
        saveData();
        renderGPA();
    };

    const deleteGrade = (id) => {
        state.grades = state.grades.filter(x => x.id !== id);
        saveData();
    };

    const addExtra = (subjectId) => {
        state.extras.push({
            id: generateId(),
            subjectId,
            name: "√öj Pluszpont",
            score: 0
        });
        saveData();
    };

    const updateExtra = (id, field, value) => {
        const e = state.extras.find(x => x.id === id);
        if (!e) return;
        if (field === "score") {
            e.score = sanitizeInput(value, "number");
        } else {
            e[field] = sanitizeInput(value);
        }
        saveData();
    };

    const deleteExtra = (id) => {
        state.extras = state.extras.filter(e => e.id !== id);
        saveData();
    };

    const updateExamGrade = (subjectId, value) => {
        if (value === "") {
            delete state.manualExamGrades[subjectId];
        } else {
            state.manualExamGrades[subjectId] = parseInt(value);
        }
        saveData();
    };

    const switchTab = (tab) => {
        state.currentTab = tab;
        document.querySelectorAll(".tab-item").forEach(t => t.classList.remove("active"));
        document.getElementById(`tab-${tab}`)?.classList.add("active");
        document.getElementById("view-grades").classList.toggle("hidden", tab !== "grades");
        document.getElementById("view-extras").classList.toggle("hidden", tab !== "extras");
        document.getElementById("view-summary").classList.toggle("hidden", tab !== "summary");
        document.getElementById("view-gpa").classList.toggle("hidden", tab !== "gpa");
        render();
    };

    const resetData = () => {
        if (!confirm("Biztosan t√∂r√∂lsz mindent?")) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    };

    const reload = () => location.reload();

    const openImportModal = () => {
        const modal = document.getElementById("import-modal");
        if (!modal) return;
        modal.classList.remove("hidden");
        modal.innerHTML = `
            <div class="modal-content w-full max-w-2xl p-8 animate-scale-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-3xl font-bold text-gray-800 mb-2">Excel Import√°l√°s</h3>
                        <p class="text-gray-600">T√∂ltsd fel az Excel f√°jlodat</p>
                    </div>
                    <button onclick="app.closeImportModal()" class="w-10 h-10 rounded-full hover:bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-times text-gray-400 text-xl"></i>
                    </button>
                </div>
                <div id="drop-area" class="border-4 border-dashed border-purple-300 bg-purple-50 rounded-2xl p-12 text-center cursor-pointer hover:border-purple-500 hover:bg-purple-100">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls, .csv">
                    <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-purple-500 to-purple-700 flex items-center justify-center">
                        <i class="fas fa-cloud-upload-alt text-white text-3xl"></i>
                    </div>
                    <p class="text-xl font-bold text-gray-800 mb-2">Kattints vagy h√∫zd ide a f√°jlt</p>
                    <p class="text-gray-500">T√°mogatott: .xlsx, .xls, .csv</p>
                </div>
                <div id="import-preview" class="hidden mt-6 space-y-4">
                    <div class="glass-card p-6 bg-gradient-to-r from-green-50 to-blue-50">
                        <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-check-circle text-green-500"></i>
                            Sikeres feldolgoz√°s!
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="flex items-center gap-3 p-4 bg-white rounded-xl">
                                <i class="fas fa-book text-2xl text-purple-500"></i>
                                <div>
                                    <p class="text-sm text-gray-500">Tant√°rgyak</p>
                                    <p id="preview-subjects-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-4 bg-white rounded-xl">
                                <i class="fas fa-clipboard-check text-2xl text-blue-500"></i>
                                <div>
                                    <p class="text-sm text-gray-500">Z√°rthelyik</p>
                                    <p id="preview-grades-count" class="text-2xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="app.confirmImport()" class="btn btn-primary flex-1 py-4 text-lg shadow-lg">
                            <i class="fas fa-download mr-2"></i>Import√°l√°s
                        </button>
                        <button onclick="app.cancelImport()" class="btn btn-secondary flex-1 py-4 text-lg">
                            <i class="fas fa-times mr-2"></i>M√©gse
                        </button>
                    </div>
                </div>
            </div>
        `;
        setupDragAndDrop();
    };

    const closeImportModal = () => {
        const modal = document.getElementById("import-modal");
        if (!modal) return;
        modal.classList.add("hidden");
    };

    const cancelImport = () => {
        pendingImport = null;
        closeImportModal();
    };

    const setupDragAndDrop = () => {
        const dropArea = document.getElementById("drop-area");
        const fileInput = document.getElementById("file-input");
        if (!dropArea || !fileInput) return;

        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        ["dragenter", "dragover", "dragleave", "drop"].forEach(evt =>
            dropArea.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); })
        );

        ["dragenter", "dragover"].forEach(evt =>
            dropArea.addEventListener(evt, () => {
                dropArea.classList.add("border-purple-500", "bg-purple-100");
            })
        );

        ["dragleave", "drop"].forEach(evt =>
            dropArea.addEventListener(evt, () => {
                dropArea.classList.remove("border-purple-500", "bg-purple-100");
            })
        );

        dropArea.addEventListener("click", () => fileInput.click());
        dropArea.addEventListener("drop", e => {
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
    };

    const handleFile = (file) => {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => processExcel(e.target.result);
        reader.onerror = () => showError("F√°jl olvas√°si hiba");
        reader.readAsArrayBuffer(file);
    };

    const processExcel = (buffer) => {
        try {
            const workbook = XLSX.read(buffer, { type: "array" });
            const foundSubjects = new Map();
            const foundGrades = [];

            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

                let headerRow = -1, headers = [];

                for (let i = 0; i < Math.min(rows.length, 20); i++) {
                    const row = rows[i];
                    if (!row) continue;
                    const lowered = row.map(c => String(c || "").trim().toLowerCase());
                    if (lowered.some(c => c.includes("tant√°rgy") || c.includes("t√°rgy") || c.includes("subject"))) {
                        headerRow = i;
                        headers = lowered;
                        break;
                    }
                }

                if (headerRow === -1) return;

                const col = {
                    name: headers.findIndex(h => h.includes("tant√°rgy") || h.includes("subject") || h.includes("t√°rgy")),
                    credit: headers.findIndex(h => h.includes("kredit")),
                    date: headers.findIndex(h => h.includes("d√°tum") || h.includes("date")),
                    score: headers.findIndex(h => h.includes("pont") || h.includes("score")),
                };

                for (let i = headerRow + 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;

                    const nameVal = col.name >= 0 ? String(row[col.name] || "").trim() : "";
                    if (!nameVal || nameVal.length < 3) continue;

                    if (!foundSubjects.has(nameVal)) {
                        foundSubjects.set(nameVal, {
                            name: nameVal,
                            credit: col.credit >= 0 ? parseInt(row[col.credit] || 3) : 3,
                            compulsory: true
                        });
                    }

                    if (col.date >= 0) {
                        let parsedDate = null;
                        const raw = row[col.date];
                        if (typeof raw === "number") {
                            const d = XLSX.SSF.parse_date_code(raw);
                            parsedDate = new Date(d.y, d.m - 1, d.d).toISOString().split("T")[0];
                        } else {
                            const d = new Date(raw);
                            if (!isNaN(d)) parsedDate = d.toISOString().split("T")[0];
                        }

                        if (parsedDate) {
                            foundGrades.push({
                                tempName: nameVal,
                                date: parsedDate,
                                score: col.score >= 0 ? parseFloat(row[col.score]) || null : null
                            });
                        }
                    }
                }
            });

            pendingImport = {
                subjects: Array.from(foundSubjects.values()),
                grades: foundGrades
            };

            document.getElementById("drop-area").classList.add("hidden");
            const preview = document.getElementById("import-preview");
            preview.classList.remove("hidden");
            document.getElementById("preview-subjects-count").innerText = pendingImport.subjects.length;
            document.getElementById("preview-grades-count").innerText = pendingImport.grades.length;

        } catch (err) {
            console.error("Excel import error:", err);
            showError("Nem siker√ºlt feldolgozni a f√°jlt.");
        }
    };

    const confirmImport = () => {
        if (!pendingImport) return;

        let addedSubjects = 0, addedGrades = 0;

        pendingImport.subjects.forEach(newSub => {
            const exists = state.subjects.some(s => s.name.trim().toLowerCase() === newSub.name.trim().toLowerCase());
            if (!exists) {
                state.subjects.push({ id: generateId(), ...newSub });
                addedSubjects++;
            }
        });

        pendingImport.grades.forEach(g => {
            const sub = state.subjects.find(s => s.name.trim().toLowerCase() === g.tempName.trim().toLowerCase());
            if (sub) {
                state.grades.push({
                    id: generateId(),
                    subjectId: sub.id,
                    date: g.date,
                    score: g.score
                });
                addedGrades++;
            }
        });

        pendingImport = null;
        saveData();
        closeImportModal();
        switchTab("grades");

        const popup = document.createElement("div");
        popup.className = "modal-backdrop";
        popup.innerHTML = `
            <div class="glass-card p-8 max-w-md text-center animate-scale-in">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-green-500 to-green-700 flex justify-center items-center">
                    <i class="fas fa-check text-white text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Sikeres import!</h3>
                <p class="text-gray-600 mb-4">
                    üìö √öj tant√°rgyak: <b>${addedSubjects}</b><br>
                    üìù √öj ZH: <b>${addedGrades}</b>
                </p>
                <button onclick="this.closest('.modal-backdrop').remove()" class="btn btn-primary">OK</button>
            </div>
        `;
        document.body.appendChild(popup);
    };

    const init = () => {
        loadData();
        createParticles();
        render();
        
        // Keyboard shortcuts for undo/redo
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            } else if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                redo();
            }
        });
    };

    return {
        init, reload, resetData, switchTab,
        addSubject, updateSubject, deleteSubject,
        addGradeRow, updateGrade, deleteGrade,
        addExtra, updateExtra, deleteExtra,
        updateExamGrade,
        openImportModal, closeImportModal, cancelImport, confirmImport,
        undo, redo
    };
})();

window.addEventListener("DOMContentLoaded", () => app.init());
    </script>
</body>
</html>